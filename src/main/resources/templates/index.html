<div th:replace="fragments/layout :: layout(~{::body}, 'home')">
    <div th:fragment="body">
        <div class="container py-4">
            <!-- Loading Spinner -->
            <div id="loading-spinner" class="text-center py-5" style="display: none;">
                <div class="spinner-border text-warning" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 text-muted">Loading more articles...</p>
            </div>
            
            <!-- News Grid -->
            <div id="news-container" class="row g-4">
                <div class="col-12 col-md-6 col-lg-4" th:each="feed : ${results}">
                    <div class="card h-100 bg-dark text-light border-0 shadow-sm" style="background: rgba(255,255,255,0.1) !important; border: 1px solid rgba(255,255,255,0.2) !important;">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title fw-bold" style="color: white !important;" th:text="${feed.title}">News Title</h5>
                            <div th:if="${feed.imageUrl != null and feed.imageUrl != ''}" class="mb-3 text-center">
                                <img th:src="${feed.imageUrl}" th:alt="${feed.title}" class="img-fluid rounded" style="max-height:180px; object-fit:cover;" loading="lazy" onerror="this.style.display='none'" />
                            </div>
                            <div class="mb-2 text-muted small" style="color: rgba(255,255,255,0.6) !important;" th:text="${feed.publishedAgo}">2025-07-19T15:51:36Z</div>
                            <div class="mb-2 card-text" style="color: rgba(255,255,255,0.8) !important;" th:text="${feed.entry}">Summary</div>
                            <div class="mt-auto">
                                <a th:if="${feed.uri != null}" th:href="${feed.uri}" th:target="_blank" class="btn btn-link p-0" style="color: #ffb366 !important;">more</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- No Articles Message -->
            <div id="no-articles" th:if="${results == null or results.isEmpty()}" class="text-center text-muted mt-5">
                <h4 style="color: #ffb366;">No articles found.</h4>
                <p style="color: rgba(255,255,255,0.7);">Try adjusting your search criteria or check back later for new content.</p>
            </div>
            
            <!-- Pagination Controls -->
            <div id="pagination-controls" th:if="${totalPages > 1}" class="d-flex justify-content-center mt-5">
                <nav aria-label="News pagination">
                    <ul class="pagination pagination-lg">
                        <!-- Previous Page -->
                        <li class="page-item" th:classappend="${!hasPreviousPage} ? 'disabled'">
                            <a class="page-link" th:if="${hasPreviousPage}" th:href="@{/}?page={page}&size={size}&category={category}&query={query}" 
                               th:with="page=${currentPage - 1}, size=${pageSize}, category=${category}, query=${query}" 
                               onclick="return loadPage(event, this.href)">
                                <i class="fa-solid fa-chevron-left"></i> Previous
                            </a>
                            <span class="page-link" th:unless="${hasPreviousPage}">
                                <i class="fa-solid fa-chevron-left"></i> Previous
                            </span>
                        </li>
                        
                        <!-- Page Numbers -->
                        <li class="page-item" th:each="pageNum : ${#numbers.sequence(1, totalPages)}" 
                            th:classappend="${pageNum == currentPage} ? 'active'">
                            <a class="page-link" th:if="${pageNum != currentPage}" 
                               th:href="@{/}?page={page}&size={size}&category={category}&query={query}" 
                               th:with="page=${pageNum}, size=${pageSize}, category=${category}, query=${query}" 
                               th:text="${pageNum}" onclick="return loadPage(event, this.href)"></a>
                            <span class="page-link" th:if="${pageNum == currentPage}" th:text="${pageNum}"></span>
                        </li>
                        
                        <!-- Next Page -->
                        <li class="page-item" th:classappend="${!hasNextPage} ? 'disabled'">
                            <a class="page-link" th:if="${hasNextPage}" th:href="@{/}?page={page}&size={size}&category={category}&query={query}" 
                               th:with="page=${currentPage + 1}, size=${pageSize}, category=${category}, query=${query}" 
                               onclick="return loadPage(event, this.href)">
                                Next <i class="fa-solid fa-chevron-right"></i>
                            </a>
                            <span class="page-link" th:unless="${hasNextPage}">
                                Next <i class="fa-solid fa-chevron-right"></i>
                            </span>
                        </li>
                    </ul>
                </nav>
            </div>
            
            <!-- Infinite Scroll Trigger -->
            <div id="infinite-scroll-trigger" th:if="${hasNextPage}" class="text-center mt-4">
                <button id="load-more-btn" class="btn btn-outline-warning btn-lg" onclick="loadMoreArticles()">
                    <i class="fa-solid fa-plus"></i> Load More Articles
                </button>
            </div>
            
            <!-- End of Articles Message -->
            <div id="end-of-articles" th:unless="${hasNextPage}" class="text-center text-muted mt-4" style="display: none;">
                <p><i class="fa-solid fa-check-circle"></i> You've reached the end of all articles.</p>
            </div>
        </div>
        
        <!-- Pagination JavaScript -->
        <script th:inline="javascript">
            // Pagination state
            let currentPage = [[${currentPage}]];
            let totalPages = [[${totalPages}]];
            let pageSize = [[${pageSize}]];
            let isLoading = false;
            
            // Load page via AJAX
            function loadPage(event, url) {
                event.preventDefault();
                if (isLoading) return false;
                
                showLoadingSpinner();
                isLoading = true;
                
                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.text();
                    })
                    .then(html => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        
                        // Update news container
                        const newContainer = doc.querySelector('#news-container');
                        const currentContainer = document.querySelector('#news-container');
                        if (newContainer && currentContainer) {
                            currentContainer.innerHTML = newContainer.innerHTML;
                        }
                        
                        // Update pagination controls
                        const newPagination = doc.querySelector('#pagination-controls');
                        const currentPagination = document.querySelector('#pagination-controls');
                        if (newPagination && currentPagination) {
                            currentPagination.innerHTML = newPagination.innerHTML;
                        }
                        
                        // Update infinite scroll trigger
                        const newTrigger = doc.querySelector('#infinite-scroll-trigger');
                        const currentTrigger = document.querySelector('#infinite-scroll-trigger');
                        if (newTrigger && currentTrigger) {
                            currentTrigger.innerHTML = newTrigger.innerHTML;
                        }
                        
                        // Update end of articles message
                        const newEndMessage = doc.querySelector('#end-of-articles');
                        const currentEndMessage = document.querySelector('#end-of-articles');
                        if (newEndMessage && currentEndMessage) {
                            currentEndMessage.style.display = newEndMessage.style.display;
                        }
                        
                        // Update URL without page reload
                        window.history.pushState({}, '', url);
                        
                        // Scroll to top
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                        
                        hideLoadingSpinner();
                        isLoading = false;
                    })
                    .catch(error => {
                        console.error('Error loading page:', error);
                        hideLoadingSpinner();
                        isLoading = false;
                        // Fallback to regular navigation
                        window.location.href = url;
                    });
                
                return false;
            }
            
            // Load more articles for infinite scroll
            function loadMoreArticles() {
                if (isLoading || currentPage >= totalPages) return;
                
                const loadMoreBtn = document.getElementById('load-more-btn');
                if (loadMoreBtn) {
                    loadMoreBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Loading...';
                    loadMoreBtn.disabled = true;
                }
                
                isLoading = true;
                currentPage++;
                
                const url = new URL(window.location);
                url.searchParams.set('page', currentPage);
                url.searchParams.set('size', pageSize);
                
                fetch('/api/news?' + url.searchParams.toString())
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        
                        // Append new articles
                        const container = document.querySelector('#news-container');
                        if (container && data.articles) {
                            data.articles.forEach(article => {
                                const articleHtml = createArticleHTML(article);
                                container.insertAdjacentHTML('beforeend', articleHtml);
                            });
                        }
                        
                        // Update infinite scroll trigger
                        const trigger = document.querySelector('#infinite-scroll-trigger');
                        if (!data.hasNextPage && trigger) {
                            trigger.style.display = 'none';
                            const endMessage = document.getElementById('end-of-articles');
                            if (endMessage) {
                                endMessage.style.display = 'block';
                            }
                        }
                        
                        // Re-enable load more button
                        if (loadMoreBtn) {
                            loadMoreBtn.innerHTML = '<i class="fa-solid fa-plus"></i> Load More Articles';
                            loadMoreBtn.disabled = false;
                        }
                        
                        isLoading = false;
                    })
                    .catch(error => {
                        console.error('Error loading more articles:', error);
                        currentPage--; // Revert page number
                        
                        if (loadMoreBtn) {
                            loadMoreBtn.innerHTML = '<i class="fa-solid fa-plus"></i> Load More Articles';
                            loadMoreBtn.disabled = false;
                        }
                        
                        isLoading = false;
                        alert('Error loading more articles. Please try again.');
                    });
            }
            
            // Create article HTML from data
            function createArticleHTML(article) {
                return `
                    <div class="col-12 col-md-6 col-lg-4">
                        <div class="card h-100 bg-dark text-light border-0 shadow-sm" style="background: rgba(255,255,255,0.1) !important; border: 1px solid rgba(255,255,255,0.2) !important;">
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title fw-bold" style="color: white !important;">${article.title || 'News Title'}</h5>
                                ${article.imageUrl ? `
                                    <div class="mb-3 text-center">
                                        <img src="${article.imageUrl}" alt="${article.title || 'News image'}" class="img-fluid rounded" style="max-height:180px; object-fit:cover;" loading="lazy" onerror="this.style.display='none'" />
                                    </div>
                                ` : ''}
                                <div class="mb-2 text-muted small" style="color: rgba(255,255,255,0.6) !important;">${article.publishedAgo || ''}</div>
                                <div class="mb-2 card-text" style="color: rgba(255,255,255,0.8) !important;">${article.entry || 'Summary'}</div>
                                <div class="mt-auto">
                                    ${article.uri ? `<a href="${article.uri}" target="_blank" class="btn btn-link p-0" style="color: #ffb366 !important;">more</a>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Show/hide loading spinner
            function showLoadingSpinner() {
                const spinner = document.getElementById('loading-spinner');
                if (spinner) spinner.style.display = 'block';
            }
            
            function hideLoadingSpinner() {
                const spinner = document.getElementById('loading-spinner');
                if (spinner) spinner.style.display = 'none';
            }
            
            // Infinite scroll with intersection observer
            const observerOptions = {
                root: null,
                rootMargin: '100px',
                threshold: 0.1
            };
            
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting && !isLoading && currentPage < totalPages) {
                        loadMoreArticles();
                    }
                });
            }, observerOptions);
            
            // Observe the load more button for infinite scroll
            document.addEventListener('DOMContentLoaded', function() {
                const loadMoreBtn = document.getElementById('load-more-btn');
                if (loadMoreBtn) {
                    observer.observe(loadMoreBtn);
                }
            });
        </script>
    </div>
</div>